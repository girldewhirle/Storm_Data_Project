---
title: "Evaluation of Population Health and Economic Damage caused by Storms and Severe Weather"
author: "girldewhirle"
date: "Monday, May 11, 2015"
output: html_document
---

## Synopsis

This analysis is to assess the impact, both in terms of human fatalities/injuries and economic damage, that extreme weather events cause in the US.  The data for this analysis was obtained from [U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database](U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database).  The analysis focuses on answering two questions:  

- Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
- Across the United States, which types of events have the greatest economic consequences?

## Data Processing

Load libraries required for data cleanse and analysis

```{r,echo=TRUE}
## load libraries
library("plyr")
library("dplyr")
library("tidyr")
library("lubridate")
library("knitr")
library("stringr")
```

Download data from source and read into workspace.

```{r}
## download and read in data
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2","Stormdata",method="curl")
storm_data<-read.csv("Stormdata",header=TRUE)
```

For ease of cleanse and analysis the data was split into two main subsets: events causing human fatalities and/or injuries, and events causing economic damage.

*Human Impact*

```{r,echo=TRUE}
## filter based on fatalities or injuries != 0
human<-filter(storm_data,FATALITIES!=0|INJURIES!=0)
## create table of unique event types from the human data set
unique_human<-as.data.frame(table(human$EVTYPE))
## remove instances that have frequency of zero
unique_human<-filter(unique_human,Freq!=0)
## arrange in descending frequency as will start running functions based on most common types
unique_human<-arrange(unique_human,desc(Freq))
## rename column
colnames(unique_human)[1]<-"Event"
## convert Event column to character
unique_human$Event<-as.character(unique_human$Event)
## convert Event column to upper case
unique_human$Event<-toupper(unique_human$Event)
```

*Economic Impact*

```{r,echo=TRUE}
## create data set where property or crop damage != 0
economic<-filter(storm_data,PROPDMG!=0|CROPDMG!=0)

## create list of unique event types from economic data
unique_economic<-as.data.frame(table(economic$EVTYPE))
## run str_trim on values
unique_economic<-mutate(unique_economic,event2=str_trim(Var1))
## sort by frequency
unique_economic<-arrange(unique_economic,desc(Freq))
```

**Creation of Helper Functions**

A number of helper functions were created to run against the EVTYPE data to standardise the values.

A variable of the 48 standard values from the [National Weather Service Storm Data Documentation] (https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

This was then used in a helper function during analysis to identify progress in standardising values.


```{r,echo=TRUE}
## create variable of standard event values from documentation
standard_events<-c("Astronomical Low Tide","Avalanche","Blizzard","Coastal Flood","Cold/Wind Chill","Debris Flow","Dense Fog","Dense Smoke","Drought","Dust Devil","Dust Storm","Excessive Heat","Extreme Cold/Wind Chill","Flash Flood","Flood","Frost/Freeze","Funnel Cloud","Freezing Fog","Hail","Heat","Heavy Rain","Heavy Snow","High Surf","High Wind","Hurricane (Typhoon)","Ice Storm","Lake-Effect Snow","Lakeshore Flood","Lightning","Marine Hail","Marine High Wind","Marine Strong Wind","Marine Thunderstorm Wind","Rip Current","Seiche","Sleet","Storm Surge/Tide","Strong Wind","Thunderstorm Wind","Tornado","Tropical Depression","Tropical Storm","Tsunami","Volcanic Ash","Waterspout","Wildfire","Winter Storm","Winter Weather")
## create helper function to check if values are standardised sucessfully

```

The functions were written individually based on the standard values so that the order they are applied to the different data subsets can be varied and, if some of the standard values do not exist in any subset then the function is not required at all.


```{r,echo=TRUE}
## create number of helper functions to clean event types
flood<-function(event_type){
  out<-event_type
  flood_check<-(grepl("flood",event_type,ignore.case=TRUE)|grepl(" fld",event_type,ignore.case=TRUE))&!(grepl("coastal",event_type,ignore.case=TRUE)|grepl("flash",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Flood"
    return(out)
  }
  return(out)
}

coastal_flood<-function(event_type){
  out<-event_type
  check<-grepl("flood",event_type,ignore.case=TRUE)&grepl("coastal",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"Coastal Flood"
    return(out)
  }
  return(out)
}

flash_flood<-function(event_type){
  out<-event_type
  check<-(grepl("flood",event_type,ignore.case=TRUE)|grepl("fld",event_type,ignore.case=TRUE))&grepl("flash",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"Flash Flood"
    return(out)
  }
  return(out)
}

snow<-function(event_type){
  out<-event_type
  flood_check<-(grepl("snow",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Heavy Snow"
    return(out)
  }
  
  return(out)
}

high_wind<-function(event_type){
  out<-event_type
  flood_check<-(grepl("high wind",event_type,ignore.case=TRUE)|grepl("gusty",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"High Wind"
    return(out)
  }
  
  return(out)
}

rip_current<-function(event_type){
  out<-event_type
  flood_check<-(grepl("rip current",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Rip Current"
    return(out)
  }
  
  return(out)
}


thunderstorm_wind<-function(event_type){
  out<-event_type
  flood_check<-((grepl("thunderstorm wind",event_type,ignore.case=TRUE)|grepl("TSTM wind",event_type,ignore.case=TRUE)|grepl("thunder",event_type,ignore.case=TRUE)|grepl("microburst",event_type,ignore.case=TRUE))&!grepl("marine",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Thunderstorm Wind"
    return(out)
  }
  
  return(out)
}

marine_thunderstorm_wind<-function(event_type){
  out<-event_type
  flood_check<-((grepl("thunderstorm wind",event_type,ignore.case=TRUE)|grepl("TSTM wind",event_type,ignore.case=TRUE)|grepl("thunder",event_type,ignore.case=TRUE))&grepl("marine",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Marine Thunderstorm Wind"
    return(out)
  }
  
  return(out)
}

tornado<-function(event_type){
  out<-event_type
  flood_check<-(grepl("tornado",event_type,ignore.case=TRUE)&!grepl("marine",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Tornado"
    return(out)
  }
  
  return(out)
}

lightning<-function(event_type){
  out<-event_type
  flood_check<-(grepl("lightning",event_type,ignore.case=TRUE)&!grepl("marine",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Lightning"
    return(out)
  }
  
  return(out)
}

excessive_heat<-function(event_type){
  out<-event_type
  flood_check<-(grepl(" heat",event_type,ignore.case=TRUE))|grepl("heat wave",event_type,ignore.case=TRUE)
  if (flood_check==TRUE){
    out<-"Excessive Heat"
    return(out)
  }
  return(out)
}

wildfire<-function(event_type){
  out<-event_type
  flood_check<-(grepl("wild",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Wildfire"
    return(out)
  }
  return(out)
}

landslide_debris_flow<-function(event_type){
  out<-event_type
  flood_check<-(grepl("slide",event_type,ignore.case=TRUE))|(grepl("debris",event_type,ignore.case=TRUE)&grepl("flow",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    out<-"Debris Flow"
    return(out)
  }
  return(out)
}

extreme_cold<-function(event_type){
  out<-event_type
  flood_check<-(grepl("cold",event_type,ignore.case=TRUE))|grepl("wind chill",event_type,ignore.case=TRUE)|grepl("hypoth",event_type,ignore.case=TRUE)
  if (flood_check==TRUE){
    out<-"Extreme Cold/Wind Chill"
    return(out)
  }
  return(out)
}

fog<-function(event_type){
  out<-event_type
  flood_check<-(grepl("fog",event_type,ignore.case=TRUE))
  if (flood_check==TRUE){
    freeze<-grepl("freeze",event_type,ignore.case=TRUE)
    if (freeze==TRUE){
      out<-"Freezing Fog"
      return(out)
    }
    out<-"Dense Fog"    
    return(out)
  }
  return(out)
}

winter_weather<-function(event_type){
  out<-event_type
  check<-grepl("winter",event_type,ignore.case=TRUE)&grepl("weather",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"Winter Weather"
    return(out)
  }
  return(out)
}

surf<-function(event_type){
  out<-event_type
  check<-grepl("surf",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"High Surf"
    return(out)
  }
  return(out)
}

surge<-function(event_type){
  out<-event_type
  check<-grepl("surge",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"STORM SURGE/TIDE"
    return(out)
  }
  return(out)
}

hail<-function(event_type){
  out<-event_type
  check<-grepl("hail",event_type,ignore.case=TRUE)&!grepl("marine",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"Hail"
    return(out)
  }
  return(out)
}

hurricane<-function(event_type){
  out<-event_type
  check<-grepl("cane",event_type,ignore.case=TRUE)|grepl("phoon",event_type,ignore.case=TRUE)
  if (check==TRUE){
    out<-"Hurricane (Typhoon)"
    return(out)
  }
  return(out)
}
```

The helper functions were run in order of event frequency down the event table until all listed events had a matching standardised value.  This was done on the human data and the economic data seperately.


```{r,echo=TRUE}
## first run of human data - all values - may need to remove from report

## run helper functions on events from human to create a merge table
## as work through remove working columns
unique_human<-mutate(unique_human,event2=mapply(tornado,Event))
unique_human<-mutate(unique_human,event3=mapply(lightning,event2))
unique_human<-mutate(unique_human,event4=mapply(thunderstorm_wind,event3))
unique_human<-mutate(unique_human,event5=mapply(excessive_heat,event4))
## trim working columns
unique_human<-select(unique_human,-(event2:event4))
## continue creating merge table
unique_human<-mutate(unique_human,event6=mapply(high_wind,event5))
unique_human<-mutate(unique_human,event7=mapply(flood,event6))
unique_human<-mutate(unique_human,event8=mapply(rip_current,event7))
## trim working columns
unique_human<-select(unique_human,-(event5:event7))
## continue creating merge table
unique_human<-mutate(unique_human,eventsnow=mapply(snow,event8))
unique_human<-mutate(unique_human,event9=mapply(wildfire,eventsnow))
unique_human<-mutate(unique_human,event10=mapply(extreme_cold,event9))
unique_human<-mutate(unique_human,event11=mapply(fog,event10))
unique_human<-mutate(unique_human,event12=mapply(fog,event11))
## trim working columns
unique_human<-select(unique_human,-(event8:event11))
## continue creating merge table
unique_human<-mutate(unique_human,event13=mapply(surf,event12))
```

```{r,echo=TRUE}
## create subset only including event type, number of fatalities, number of injuries and reference number
minimal_human<-select(human,EVTYPE,FATALITIES,INJURIES,REFNUM)
## create variable which is a result of fatalities + injuries
minimal_human<-mutate(minimal_human,fat_plus_inj=FATALITIES+INJURIES)
## find value for top 1%
top_1_per_cutoff<-quantile(minimal_human$fat_plus_inj,prob=0.99)
## subset data to top 1% max human impact
top_human_impact<-filter(minimal_human,fat_plus_inj>top_1_per_cutoff)
## create table of unique values with frequency to be basis of mapping table
unique_top_human<-as.data.frame(table(top_human_impact$EVTYPE))
## filter out zero frequencies
unique_top_human<-filter(unique_top_human,Freq>0)
## sort in descending order as will start to apply helper functions based on most frequent in top 1%
unique_top_human<-arrange(unique_top_human,desc(Freq))
## convert Var1 to character
unique_top_human$Var1<-as.character(unique_top_human$Var1)

## start cleaning in following order
##tornado, excessive heat, flood, heat (not run), flash flood, hurricane/typhoon
## at this point checked for remaining none standard values - only extreme cold and wildfire left
unique_top_human<-mutate(unique_top_human,ev2=mapply(tornado,Var1))%>%
  mutate(ev3=mapply(excessive_heat,ev2))%>%
  mutate(ev4=mapply(flood,ev3))%>%
  mutate(ev5=mapply(flash_flood,ev4))%>%
  mutate(ev6=mapply(hurricane,ev5))%>%
  mutate(ev7=mapply(extreme_cold,ev6))%>%
  mutate(ev8=mapply(wildfire,ev7))
## resulting table is now merge table so crop down to use
unique_top_human<-select(unique_top_human,Var1,ev8)
## rename to allow join
colnames(unique_top_human)[1]<-"EVTYPE"
colnames(unique_top_human)[2]<-"cleaned_EVTYPE"
## join with top % human impact file to get cleaned values
minimal_cleaned_human<-join(top_human_impact,unique_top_human)
## trim table
minimal_cleaned_human<-select(minimal_cleaned_human,cleaned_EVTYPE,FATALITIES:REFNUM,fat_plus_inj)
## grouped by event type
grouped_ev_type<-group_by(minimal_cleaned_human,cleaned_EVTYPE)
## summarise and get mean fatalities and mean injuries and also total(sum) values
## as integer for clarity
Mean_Human_Impact<-summarise(grouped_ev_type,as.integer(mean(FATALITIES)),as.integer(mean(INJURIES)),as.integer(sum(FATALITIES)),as.integer(sum(INJURIES)),as.integer(mean(fat_plus_inj)),as.integer(sum(fat_plus_inj)))

## rename columns
colnames(Mean_Human_Impact)[2]<-"Mean_Fatalities"
colnames(Mean_Human_Impact)[3]<-"Mean_Injuries"
colnames(Mean_Human_Impact)[4]<-"Total_Fatalities"
colnames(Mean_Human_Impact)[5]<-"Total_Injuries"
colnames(Mean_Human_Impact)[6]<-"Mean_Human_Impact"
colnames(Mean_Human_Impact)[7]<-"Total_Human_Impact"
## arrange in desc order fatalities
Mean_Human_Impact<-arrange(Mean_Human_Impact,desc(Total_Human_Impact))
```

```{r,echo=TRUE}
## display table
kable(Mean_Human_Impact)
```


```{r,echo=TRUE}
## start running cleaning functions starting with most frequent
unique_economic<-mutate(unique_economic,event3=mapply(thunderstorm_wind,event2))
unique_economic<-mutate(unique_economic,event4=mapply(tornado,event3))
unique_economic<-mutate(unique_economic,event5=mapply(flood,event4))
unique_economic<-mutate(unique_economic,event6=mapply(high_wind,event5))
unique_economic<-mutate(unique_economic,event7=mapply(wildfire,event6))
## remove working columns
unique_economic<-select(unique_economic,-(event2:event6))
## continue to clean
unique_economic<-mutate(unique_economic,event8=mapply(flash_flood,event7))
unique_economic<-mutate(unique_economic,event9=mapply(landslide_debris_flow,event8))
unique_economic<-mutate(unique_economic,event10=mapply(surge,event9))
## remove working columns
unique_economic<-select(unique_economic,-(event7:event9))
## continue to clean
unique_economic<-mutate(unique_economic,event11=mapply(hurricane,event10))
unique_economic<-mutate(unique_economic,event12=mapply(winter_weather,event11))
unique_economic<-mutate(unique_economic,event13=mapply(snow,event12))
unique_economic<-mutate(unique_economic,event14=mapply(marine_thunderstorm_wind,event13))
unique_economic<-mutate(unique_economic,event15=mapply(extreme_cold,event14))
unique_economic<-mutate(unique_economic,event16=mapply(fog,event15))
unique_economic<-mutate(unique_economic,event17=mapply(coastal_flood,event16))
```

